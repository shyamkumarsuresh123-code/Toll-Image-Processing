<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toy Car Lane Detector (Local)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        
        /* Mirror the video and canvas for natural feel */
        #cam-container { transform: scaleX(-1); }

        /* The Lane Overlay (Visual Only) */
        .lane-box {
            border: 3px dashed #0ea5e9; /* Cyan */
            background: rgba(14, 165, 233, 0.1);
            position: absolute;
            transition: all 0.2s;
        }

        .lane-active {
            border-color: #10b981; /* Green */
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }
    </style>
</head>
<body class="bg-slate-950 text-emerald-400 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-2xl flex justify-between items-end mb-4 border-b border-emerald-900/50 pb-2">
        <div>
            <h1 class="text-xl font-bold text-white">LANE<span class="text-emerald-500">_MONITOR</span></h1>
            <p class="text-xs text-slate-500">ENGINE: TENSORFLOW.JS (LOCAL)</p>
        </div>
        <div id="status-badge" class="px-2 py-1 bg-yellow-500/10 text-yellow-500 text-xs font-bold rounded border border-yellow-500/20">
            LOADING MODEL...
        </div>
    </div>

    <div class="relative w-full max-w-2xl aspect-video bg-black rounded-xl border border-emerald-900 overflow-hidden shadow-2xl">
        
        <div id="cam-container" class="relative w-full h-full">
            <video id="webcam" class="w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="output" class="absolute inset-0 w-full h-full"></canvas>
            
            <div id="lane" class="lane-box" style="display: none;"></div>
        </div>

        <div class="absolute top-4 left-4 z-20 pointer-events-none">
            <div class="bg-black/80 border border-emerald-500/30 p-4 rounded backdrop-blur-sm">
                <div class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Cars in Lane</div>
                <div id="count-display" class="text-5xl font-bold text-white leading-none">0</div>
            </div>
        </div>

        <div id="start-btn-container" class="absolute inset-0 z-30 flex items-center justify-center bg-black/80">
            <button id="startBtn" class="px-8 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded transition-all disabled:opacity-50 disabled:cursor-wait" disabled>
                LOADING AI...
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TARGET_CLASSES = ['car', 'truck', 'bus']; // What objects to count
        
        // --- STATE ---
        let model = null;
        let isRunning = false;
        let laneRect = { x: 0, y: 0, w: 0, h: 0 }; // Will be calculated based on screen size

        // --- DOM ELEMENTS ---
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        const laneDiv = document.getElementById('lane');
        const countDisplay = document.getElementById('count-display');
        const statusBadge = document.getElementById('status-badge');
        const startBtn = document.getElementById('startBtn');
        const startContainer = document.getElementById('start-btn-container');

        // 1. Load the Model
        async function loadModel() {
            try {
                // Load COCO-SSD (Pre-trained object detection)
                model = await cocoSsd.load();
                
                // Update UI
                startBtn.innerText = "START CAMERA";
                startBtn.disabled = false;
                startBtn.classList.remove('bg-emerald-600');
                startBtn.classList.add('bg-emerald-500', 'animate-pulse');
                
                statusBadge.innerText = "MODEL READY";
                statusBadge.className = "px-2 py-1 bg-emerald-500/10 text-emerald-500 text-xs font-bold rounded border border-emerald-500/20";
            } catch (err) {
                console.error(err);
                startBtn.innerText = "ERROR LOADING MODEL";
            }
        }

        // 2. Start Camera
        async function startApp() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                });
                video.srcObject = stream;

                video.onloadeddata = () => {
                    startContainer.style.display = 'none';
                    isRunning = true;
                    
                    // Setup Canvas Size
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // Define Lane (Center 50% of screen)
                    updateLaneDimensions();
                    laneDiv.style.display = 'block';

                    // Start Loop
                    detectFrame();
                };
            } catch (err) {
                alert("Camera permission denied.");
            }
        }

        // 3. Define the "Lane" Box
        function updateLaneDimensions() {
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            
            // Lane is 40% width, 70% height, centered
            laneRect = {
                x: vw * 0.3,
                y: vh * 0.15,
                w: vw * 0.4,
                h: vh * 0.7
            };

            // Update the visual blue dashed box
            // Note: Since the parent container is mirrored, we just position normally
            laneDiv.style.left = laneRect.x + 'px';
            laneDiv.style.top = laneRect.y + 'px';
            laneDiv.style.width = laneRect.w + 'px';
            laneDiv.style.height = laneRect.h + 'px';
        }

        // 4. Main Detection Loop
        async function detectFrame() {
            if (!isRunning) return;

            // Clear previous drawings
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Detect objects
            const predictions = await model.detect(video);

            let carsInLane = 0;

            predictions.forEach(prediction => {
                // Check if it's a car
                if (TARGET_CLASSES.includes(prediction.class)) {
                    const [x, y, w, h] = prediction.bbox;

                    // Calculate Center of the car
                    const centerX = x + (w / 2);
                    const centerY = y + (h / 2);

                    // Check if Center is inside Lane
                    // (Strictly: Use centerX/centerY. Loosely: Use bounding box overlap)
                    // Requirement: "Present inside the frame". 
                    // We check if the CENTER of the car is inside the lane rect.
                    const isInside = (
                        centerX >= laneRect.x && 
                        centerX <= (laneRect.x + laneRect.w) &&
                        centerY >= laneRect.y && 
                        centerY <= (laneRect.y + laneRect.h)
                    );

                    if (isInside) {
                        carsInLane++;
                        drawBox(x, y, w, h, true); // Green Box
                    } else {
                        drawBox(x, y, w, h, false); // Red Box
                    }
                }
            });

            // Update Counter
            countDisplay.innerText = carsInLane;

            // Visual feedback for Lane
            if (carsInLane > 0) {
                laneDiv.classList.add('lane-active');
            } else {
                laneDiv.classList.remove('lane-active');
            }

            requestAnimationFrame(detectFrame);
        }

        function drawBox(x, y, w, h, isInside) {
            ctx.strokeStyle = isInside ? '#10b981' : '#ef4444';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.rect(x, y, w, h);
            ctx.stroke();

            // Label
            ctx.fillStyle = isInside ? '#10b981' : '#ef4444';
            ctx.font = '12px Arial';
            ctx.fillText(isInside ? "IN LANE" : "OUT", x, y - 5);
        }

        // Event Listeners
        startBtn.addEventListener('click', startApp);
        loadModel(); // Load immediately

    </script>
</body>
</html>
